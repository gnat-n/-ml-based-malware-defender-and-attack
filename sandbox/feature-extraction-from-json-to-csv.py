import numpy as np
import os
#from customfeatures import PEFeatureExtractor
from featuresJson import PEFeatureExtractor

extractor = PEFeatureExtractor(feature_version=2)

features = np.empty((0, 2381))
pe_file_paths = "/Users/skpaul/mac-tamu/dataset/malware-folder"
output_file_path = "/Users/skpaul/mac-tamu/dataset/csv/test/mal-test-csv2.csv"

counter = 0
for pe_file_path in os.listdir(pe_file_paths):
    pe_file_path = os.path.join(pe_file_paths, pe_file_path)
    # checking if it is a file
    if os.path.isfile(pe_file_path):
        putty_data = open(pe_file_path, "rb").read()
        
        #features = extractor.raw_features(putty_data)
        features_for_one_pe_file = np.array(extractor.feature_vector(putty_data), dtype=np.float32)
        features = np.vstack((features, features_for_one_pe_file))
        counter +=1
        if (counter % 2 == 0):
            with open(output_file_path, 'a') as f:
                np.savetxt(f, features, delimiter=',')
            print(counter)
            features = None
            features = np.empty((0, 2381))
        #print(features.shape)
    
#print(features.shape)

if (counter % 1000 != 0):
    with open(output_file_path, 'a') as f:
        np.savetxt(f, features, delimiter=',')
    features = None
print(counter)